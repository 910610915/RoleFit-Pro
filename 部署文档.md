# 硬件性能基准测试系统部署文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 版本 | v1.0.0 |
| 更新日期 | 2026-02-23 |
| 适用系统 | Linux / Windows Server |

---

## 一、系统要求

### 1.1 硬件要求

| 配置 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 4核心 | 8核心+ |
| 内存 | 8GB | 16GB+ |
| 磁盘 | 50GB SSD | 100GB+ SSD |
| 网络 | 100Mbps | 1Gbps |

### 1.2 软件要求

| 软件 | 版本要求 |
|------|----------|
| Docker | 20.10+ |
| Docker Compose | 2.0+ |
| 系统内核 | Linux 4.19+ / Windows Server 2019+ |

---

## 二、部署前准备

### 2.1 防火墙端口

| 端口 | 用途 | 协议 |
|------|------|------|
| 80 | 前端Web | HTTP |
| 443 | HTTPS (可选) | HTTPS |
| 8000 | 后端API | HTTP |

**CentOS/RHEL:**
```bash
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=8000/tcp
firewall-cmd --reload
```

**Ubuntu/Debian:**
```bash
ufw allow 80/tcp
ufw allow 8000/tcp
ufw reload
```

### 2.2 目录规划

```bash
# 创建部署目录
mkdir -p /opt/hardware-benchmark
cd /opt/hardware-benchmark

# 创建日志目录
mkdir -p logs/backend
mkdir -p logs/nginx
```

---

## 三、快速部署

### 3.1 一键部署

```bash
# 1. 获取部署包
git clone <repository-url> /opt/hardware-benchmark
cd /opt/hardware-benchmark

# 2. 配置环境变量（可选）
cp backend/.env.example backend/.env
cp frontend/.env.example frontend/.env
# 编辑 .env 文件，修改密码和密钥

# 3. 启动所有服务
docker-compose up -d

# 4. 查看服务状态
docker-compose ps
```

### 3.2 验证部署

```bash
# 检查容器状态
docker-compose ps

# 检查日志
docker-compose logs -f backend

# 检查端口
curl http://localhost:8000/health
curl http://localhost/
```

---

## 四、详细配置

### 4.1 环境变量配置

**后端配置 (backend/.env)**

```env
# 应用配置
APP_NAME=HardwareBenchmark
DEBUG=false
SECRET_KEY=your-super-secret-key-change-this-min-32-chars

# 数据库配置（SQLite）
DATABASE_URL=sqlite+aiosqlite:///./hardware_benchmark.db
DATABASE_URL_SYNC=sqlite:///./hardware_benchmark.db

# CORS配置
CORS_ORIGINS=http://your-domain.com,http://localhost

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440
```

**前端配置 (frontend/.env)**

```env
VITE_API_BASE_URL=http://your-domain.com/api
VITE_APP_TITLE=硬件性能基准测试系统
```

### 4.2 Docker Compose 定制

如需修改服务配置，编辑 `docker-compose.yml`:

```yaml
services:
  postgres:
    # 修改数据库密码
    environment:
      POSTGRES_PASSWORD: your_new_password
  
  backend:
    # 修改端口映射
    ports:
      - "8080:8000"  # 改为8080端口
    
    # 增加环境变量
    environment:
      - DEBUG=true
```

### 4.3 HTTPS 配置（可选）

生成SSL证书：

```bash
# 使用Let's Encrypt（需要域名）
certbot certonly --standalone -d your-domain.com

# 或使用自签名证书（测试用）
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl.key -out nginx/ssl.crt
```

修改 nginx.conf 添加HTTPS支持：

```nginx
server {
    listen 443 ssl;
    ssl_certificate /path/to/ssl.crt;
    ssl_certificate_key /path/to/ssl.key;
    
    # ... 其他配置
}
```

---

## 五、服务管理

### 5.1 常用命令

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f [服务名]

# 进入容器
docker-compose exec backend bash
docker-compose exec postgres psql -U benchmark_user

# 重建容器
docker-compose build --no-cache
docker-compose up -d
```

### 5.2 服务健康检查

```bash
# 后端API健康检查
curl http://localhost:8000/health

# Nginx健康检查
curl http://localhost/
```

---

## 六、数据管理

### 6.1 数据库备份

SQLite 数据库备份非常简单，只需复制数据库文件即可：

```bash
# 备份脚本
#!/bin/bash
BACKUP_DIR="/opt/hardware-benchmark/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 复制 SQLite 数据库文件
cp backend/hardware_benchmark.db $BACKUP_DIR/backup_$DATE.db

# 删除30天前的备份
find $BACKUP_DIR -name "backup_*.db" -mtime +30 -delete

echo "Backup completed: backup_$DATE.db"
```

### 6.2 数据库恢复

```bash
# 恢复数据
cp backup_20260226.db backend/hardware_benchmark.db
```

### 6.3 数据迁移（导出为 MySQL/PostgreSQL 格式）

系统支持将 SQLite 数据导出为 MySQL 或 PostgreSQL 格式：

```bash
# 导出为 MySQL 格式
curl http://localhost:8000/api/db/export/mysql -o mysql_dump.sql

# 导出为 PostgreSQL 格式  
curl http://localhost:8000/api/db/export/postgresql -o postgresql_dump.sql
```

---

## 七、Agent部署

### 7.1 Windows Agent安装

```powershell
# 1. 安装Python依赖
pip install -r requirements.txt

# 2. 配置Agent
# 编辑 hardware_agent.py 中的 SERVER_URL
$SERVER_URL = "http://your-server-ip:8000"

# 3. 启动Agent（前台运行测试）
python hardware_agent.py -s http://your-server-ip:8000

# 4. 部署为Windows服务（后台运行）
# 使用NSSM或Windows自带sc命令
sc create HardwareBenchmarkAgent binPath= "C:\Python\python.exe C:\agent\hardware_agent.py -s http://your-server-ip:8000" start= auto
sc start HardwareBenchmarkAgent
```

### 7.2 批量部署

使用GPO或PSSession批量部署：

```powershell
# 批量部署脚本示例
$computers = Get-Content "computer_list.txt"
$scriptPath = "C:\temp\hardware_agent.ps1"

foreach ($computer in $computers) {
    Copy-Item $scriptPath -Destination "\\$computer\C$\temp\"
    Invoke-Command -ComputerName $computer -ScriptBlock {
        Start-Process powershell -ArgumentList "-File C:\temp\hardware_agent.ps1" -WindowStyle Hidden
    }
}
```

---

## 八、运维监控

### 8.1 日志管理

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务
docker-compose logs -f backend
docker-compose logs -f postgres

# 日志轮转配置
# 在 /etc/docker/daemon.json 中添加
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

### 8.2 性能监控

```bash
# 容器资源使用
docker stats

# 查看特定容器
docker stats hardware-benchmark-backend

# 容器资源限制（docker-compose.yml）
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

### 8.3 告警配置

```bash
# 监控脚本示例
#!/bin/bash

# 检查服务健康状态
HEALTH=$(curl -s http://localhost:8000/health)

if [ "$HEALTH" != '{"status":"healthy"}' ]; then
    echo "Backend health check failed!" | mail -s "Alert" admin@example.com
fi

# 检查磁盘空间
DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    echo "Disk usage is ${DISK_USAGE}%" | mail -s "Alert" admin@example.com
fi
```

---

## 九、故障排查

### 9.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 容器启动失败 | 端口被占用 | 检查端口占用 `netstat -tlnp` |
| 数据库连接失败 | 网络不通 | 检查docker网络 `docker network ls` |
| 前端无法访问API | CORS配置错误 | 检查CORS_ORIGINS配置 |
| Agent无法注册 | 防火墙阻止 | 开放8000端口 |
| 登录失败 | 数据库无用户 | 执行初始化脚本创建admin用户 |

### 9.2 诊断命令

```bash
# 1. 检查容器状态
docker-compose ps

# 2. 查看错误日志
docker-compose logs backend --tail=100

# 3. 检查网络连接
docker network inspect hardware-benchmark-network

# 4. 检查端口监听
netstat -tlnp | grep -E '(8000|80)'

# 5. 检查资源使用
docker stats --no-stream

# 6. 进入容器调试
docker-compose exec backend /bin/bash
```

### 9.3 完全重置

```bash
# 停止并删除所有容器
docker-compose down -v

# 删除数据库文件（⚠️会删除所有数据）
rm -f backend/hardware_benchmark.db

# 重新启动
docker-compose up -d
```

---

## 十、安全加固

### 10.1 基础安全

1. **修改默认密码**
   ```bash
   # 修改数据库密码
   # 编辑 .env 文件
   
   # 修改JWT密钥
   JWT_SECRET_KEY=<生成随机密钥>
   ```

2. **限制API访问**
   ```env
   # 生产环境关闭调试
   DEBUG=false
   
   # 限制CORS
   CORS_ORIGINS=https://your-domain.com
   ```

3. **定期更新**
   ```bash
   # 更新镜像
   docker-compose pull
   
   # 重启服务
   docker-compose up -d
   ```

### 10.2 安全检查清单

- [ ] 修改默认admin密码
- [ ] 配置CORS域名限制
- [ ] 启用HTTPS（生产环境）
- [ ] 配置防火墙规则
- [ ] 定期备份数据库
- [ ] 启用日志审计
- [ ] 监控异常登录

---

## 附录

### 附录A：服务端口对照表

| 服务 | 内部端口 | 外部端口 | 访问地址 |
|------|----------|----------|----------|
| Nginx | 80 | 80 | http://localhost |
| Backend | 8000 | 8000 | http://localhost:8000 |
| SQLite | - | - | 数据库文件: backend/hardware_benchmark.db |

### 附录B：默认账号

| 账号 | 用户名 | 密码 |
|------|--------|------|
| Admin | admin | admin123 |
| API Key | - | 无（首次登录后设置） |

**首次登录后请立即修改密码！**

### 附录C：技术支持

- 文档版本: v1.0.0
- 支持邮箱: support@example.com
- 问题反馈: https://github.com/example/issues

---

*本文档最后更新于 2026-02-26*

> 注：2026-02-26 更新 - 数据库从 PostgreSQL/InfluxDB/Redis 改为 SQLite，简化部署流程
